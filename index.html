<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Conservation Map -- Preliminary</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js"></script>

    <!-- Load Esri Leaflet Vector from CDN -->
    <script src="https://unpkg.com/esri-leaflet-vector@4.2.5/dist/esri-leaflet-vector.js" crossorigin=""></script>

    <!-- Add leaflet panel layers for layer control panel-->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-panel-layers@1.3.1/dist/leaflet-panel-layers.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/leaflet-panel-layers@1.3.1/dist/leaflet-panel-layers.min.css" rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <style>
    html,
    body,
    #map {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 14px;
      color: #323232;
    }
    #info-box {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 10px;
        border: 1px solid #ccc;
        z-index: 1000;
        opacity: 0.8;
        display: none;
    }
    
    /* Custom collapsible panel styling */
    .custom-collapsible-panel {
        position: relative;
    }
    
    .custom-collapsible-panel .leaflet-panel-layers-list {
        transition: all 0.3s ease;
    }
    
    .custom-collapsible-panel.collapsed .leaflet-panel-layers-list {
        display: none;
    }
    
    /* Toggle button */
    .custom-collapsible-panel .hamburger-toggle {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 30px;
        height: 30px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 3px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1001;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        font-size: 16px;
        font-weight: bold;
        color: #333;
    }
    
    .custom-collapsible-panel .hamburger-toggle:hover {
        background: #f0f0f0;
    }
    
    /* Minimize icon (when panel is open) */
    .custom-collapsible-panel .hamburger-toggle.minimize {
        font-size: 18px;
    }
    
    /* Hamburger lines (when panel is collapsed) */
    .custom-collapsible-panel.collapsed .hamburger-toggle span {
        width: 18px;
        height: 2px;
        background: #333;
        margin: 2px 0;
        transition: 0.3s;
    }
    
    .custom-collapsible-panel.collapsed .hamburger-toggle.minimize {
        display: none;
    }
    
    .custom-collapsible-panel.collapsed .hamburger-toggle.hamburger {
        display: flex;
        flex-direction: column;
    }
    
    /* Collapsed state - show only hamburger */
    .custom-collapsible-panel.collapsed {
        width: 55px !important;
        height: 55px !important;
        min-width: 55px !important;
        min-height: 55px !important;
    }
    
    .custom-collapsible-panel.collapsed .leaflet-panel-layers-title {
        display: none;
    }
    
    .custom-collapsible-panel.collapsed .hamburger-toggle {
        position: static;
        margin: 8px;
    }
  </style>

</head>
<body>

  <div id="map"></div>
  <div id="info-box"></div>
  <script>

  // initialize the map
  
  var map = L.map('map').setView([43.835189, -72.252179], 12);

    var worldStreetMap = L.esri.basemapLayer('Streets').addTo(map);

    var imagery = L.esri.imageMapLayer({'url':"http://maps.vcgi.vermont.gov/arcgis/rest/services/EGC_services/IMG_VCGI_CLR2022_WM_CACHE/ImageServer"});
    var hillshade = L.esri.imageMapLayer({'url':"http://maps.vcgi.vermont.gov/arcgis/rest/services/EGC_services/IMG_VCGI_LIDARHILLSHD_WM_CACHE_v1/ImageServer"});
    
    worldStreetMap.addTo(map);
    
    const layerData = {"Forests":[
    {
        "name": "Interior Forest Blocks",
        "source": '<a href="https://vtfishandwildlife.com/conserve/vermont-conservation-design">Vermont Conservation Design</a>',
        "description": `According to BioFinder, "Interior Forest Blocks are a selection of habitat blocks that best provide interior forest conditions in
each biophysical region of Vermont. Habitat blocks themselves are areas of contiguous forest and
other natural habitats that are unbroken by roads, development, or agriculture".  
See <a href="https://anr.vermont.gov/sites/anr/files/documents/Interior%20Forest%20Summary.pdf">the biofinder documentation</a> for more details.`,
        "info-name": "Interior Forest Block",
        "url": "https://anrmaps.vermont.gov/arcgis/rest/services/EGC_Services/MAP_ANR_BIOFINDER4_WM_NOCACHE/MapServer/1",
        "categorical-style": {"key": "Interior_Forest_Priority", 
                              "Highest Priority":{weight:1, color:'#28B463', opacity:0.8, fillOpacity:0.3, fillColor:'#28B463'},
                              "Priority": {weight:1, color:'#28B463', opacity:0.5, fillOpacity:0.1, fillColor:'#28B463'}
                            },
        "info-params": {'Acreage': 'habitat_block_area_acres', 'Priority':'Interior_Forest_Priority', 'Biophysical Region': 'biophysical_region_name', 'Percent Conserved': 'conserved_land_pct', 'Vernal Pool Count':'vernal_pool_count'},
        "filter": `Interior_Forest='Interior Forest'`,
        'simplifyFactor': 0.3,
        'precision': 7,
    },
    {
        "name": "Forest Connectivity Blocks",
        "source": '<a href="https://anr.vermont.gov/">Vermont Agency of Natural Resource (ANR)</a>',
        "description": `According to BioFinder, "Connectivity Blocks are a selection of habitat blocks that create a connected network of forest across
Vermont and into adjacent states and provinces. These are mostly forested areas but also include
shrubland and wetland. They include the largest forests that are serving as core habitat, as well as
sometimes smaller, connecting blocks. Connectivity Blocks are the network of forest blocks that together
provide terrestrial connectivity at the regional scale, across Vermont and to adjacent states and Québec,
and connectivity between all Vermont biophysical regions."
See <a href="https://anr.vermont.gov/sites/anr/files/documents/Connectivity%20Blocks%20Summary.pdf">the biofinder documentation</a> for more details.`,
        "info-name": "Forest Connectivity Block",
        "url": "https://anrmaps.vermont.gov/arcgis/rest/services/EGC_Services/MAP_ANR_BIOFINDER4_WM_NOCACHE/MapServer/1",
        "categorical-style": {"key": "Connectivity_Blocks_Priority", 
                              "Highest Priority":{weight:1, color:'#73C6B6', opacity:0.8, fillOpacity:0.3, fillColor:'#73C6B6'},
                              "Priority": {weight:1, color:'#73C6B6', opacity:0.8, fillOpacity:0.1, fillColor:'#73C6B6'}
                            },
        "info-params": {'Acreage': 'habitat_block_area_acres', 'Priority':'Connectivity_Blocks_Priority', 'Biophysical Region': 'biophysical_region_name', 'Percent Conserved': 'conserved_land_pct', 'Vernal Pool Count':'vernal_pool_count'},
        "filter": `Connectivity_Blocks='Connectivity Block'`,
        'simplifyFactor': 0.3,
        'precision': 4,
    }],
    "Water":[
    {
        "name": "Surface Water",
        "source": '<a href="https://vtfishandwildlife.com/conserve/vermont-conservation-design">Vermont Conservation Design</a>',
        "url": "https://anrmaps.vermont.gov/arcgis/rest/services/EGC_Services/MAP_ANR_BIOFINDER4_WM_NOCACHE/MapServer/0",
        "info-name":"Highest Priority Surface Water",
        "description": `This layer contains the highest priority areas with "Vermont's network of lakes, ponds, rivers and streams, and their associated
riparian zones, valley bottoms, and river corridors".  For more information on this data and its ecological importance, consult the Vermont Conservation 
 Design's <a href="https://vtfishandwildlife.com/sites/fishandwildlife/files/documents/Conserve/VT%20Conservation%20Landscape-level%20Design/Surface-Waters-and-Riparian-Areas.pdf">Surface Waters and Riparian Areas</a> documentation. `,
        "info-params": {},
        "style": {weight:1, color:'#344ceb', opacity:0.8, fillOpacity:0.4, fillColor:'#344ceb'},
        "filter": `SurfaceWaterPriority='HIGHEST PRIORITY'`,
        'simplifyFactor': 0.3,
        'precision': 5
    },
    {
        "name": "Vernal Pools",
        "source": '<a href="https://vtfishandwildlife.com/conserve/vermont-conservation-design">Vermont Conservation Design</a>',
        "url": "https://anrmaps.vermont.gov/arcgis/rest/services/EGC_Services/MAP_ANR_BIOFINDER4_WM_NOCACHE/MapServer/2",
        "info-name":"Vernal Pools",
        "description": `Possible vernal pools with a 650ft buffer.  From the 
        <a href="https://anr.vermont.gov/sites/anr/files/documents/Vernal%20Pools%20Summary.pdf?_gl=1*f5q9ds*_ga*MTM3OTc4OTc2OC4xNzI1NDkzMTMy*_ga_V9WQH77KLW*MTczMjQ3ODc4My41LjAuMTczMjQ3ODc4NS4wLjAuMA">Vermont Conservation Design documentation</a>, 
" Vernal Pools are small (generally less than oneacre), ephemeral pools that occur in natural basins within upland forests. 
They typically have no permanent inlet or outlet streams and have very small watersheds."  This layer shows only the "highest priority" 
vernal pools, which have been field verified.`,
        "info-params": {},
        "style": {weight:1, color:'#2a7862', opacity:0.8, fillOpacity:0.8, fillColor:'#2a7862'},
        "filter": `VernalPools='HIGHEST PRIORITY'`,
        'simplifyFactor': 0.2,
        'precision': 4
    },
    {
        "name": "Wetlands",
        "source": `<a href="https://anr.vermont.gov/">VT Agency of Natural Resources<a>`,
        "url": "https://services5.arcgis.com/Uzks6LSde6r23wwG/ArcGIS/rest/services/Vermont_Significant_Wetland_Inventory/FeatureServer/0",
        "style": {weight:1, color:'#06cf82', opacity:0.8, fillOpacity:0.4, fillColor:'#06cf82'},
        "description": `Data from the <a href="https://dec.vermont.gov/watershed/wetlands/maps">Vermont Significant Wetlands Inventory (VSWI)</a>. 
        From the <a href="https://anrgeodata.vermont.gov/datasets/VTANR::vswi-wetlands-class-layer/about">ANR documentation</a>, 
        "The State of Vermont protects wetlands which provide significant functions and values and also protects a buffer zone directly
        adjacent to significant wetlands. Wetlands in Vermont are classified as Class I, II, or III based on the significance of the 
        functions and values they provide. Class I and Class II wetlands provide significant functions and values and are protected 
        by the Vermont Wetland Rules."  Additional information can be found in the 
        <a href="https://anrmaps.vermont.gov/websites/WetlandScreening/Docs/2021%20Mapping%20Guidance%20VSWI.pdf">data description</a> provided by the Vermont Wetlands Program. `,
        "info-params": {'Class':'CLASS'},
        "info-name": "Wetland",
        "filter": "1=1",
        'simplifyFactor': 0.2,
        'precision': 5
    }
], "Soils":[
    {
        "name": "Agricultural Soils",
        "source": `<a href="https://vcgi.vermont.gov/">VT Center for Geographic Information</a>`,
        "url": "https://services1.arcgis.com/BkFxaEFNwHqX3tAw/arcgis/rest/services/FS_VCGI_OPENDATA_Geologic_SOAG_poly_SP_v1/FeatureServer/0",
        "info-name":"Agricultural Soil",
        "description": `A subset of the USGS <a href="https://www.nrcs.usda.gov/resources/data-and-reports/soil-survey-geographic-database-ssurgo">"Soil Survey Geographic Database"</a>
        created by the state of Vermont to identify prime agricultural soils in the state.`,
        "info-params": {'Prime Type': 'PRIME'},
        "style": {weight:1, color:'#d6b024', opacity:0.8, fillOpacity:0.3, fillColor:'#d6b024'},
        "filter": "1=1",
        'simplifyFactor': 0.2,
        'precision': 7,
    },
], "Wildlife":[
    
    {
        "name": "Deer Wintering Areas",
        "source": `<a href="https://anr.vermont.gov/">VT Agency of Natural Resources<a>`, 
        "url": "https://anrmaps.vermont.gov/arcgis/rest/services/Open_Data/OPENDATA_ANR_ECOLOGIC_SP_NOCACHE_v1/MapServer/171",
        "style": {weight:1, color:'#A04000', opacity:0.8, fillOpacity:0.2, fillColor:'#A04000'},
        "description": `From the ANR description: "Deer winter habitat is critical to the long term survival of white-tailed 
        deer (Odocoileus virginianus) in Vermont. Being near the northern extreme of the white-tailed deer's range, 
        functional winter habitats are essential to maintain stable populations of deer in many years when and where 
        yarding conditions occur. Consequently, deer wintering areas are considered under Act 250 and other local, state,
         and federal regulations that require the protection of important wildlife habitats. DWAs are generally characterized 
         by rather dense softwood (conifer) cover, such as hemlock, balsam fir, red spruce, or white pine. Occasionally DWAs 
         are found in mixed forest with a strong softwood component or even on found west facing hardwood slopes in conjunction 
         with softwood cover." More information in VT ANR's <a href="https://vtfishandwildlife.com/sites/fishandwildlife/files/documents/Learn%20More/LandownersGuide/8.Deer_.pdf">Deer Wintering Management</a> document.`,
        "info-params": {"Acreage": "Acres", "Rating":"Rating"},
        "info-name": "Deer Wintering Area",
        "filter": "1=1",
        'simplifyFactor': 0.2,
        'precision': 5
    },
     {
         "name": "Amphibian Road Crossings",
         "source": `<a href="https://www.thetfordvt.gov/government/conservation-commission">Thetford Natural Resource Inventory (NRI)</a>`,
         "url": "https://thetford-vt-conservation.github.io/maps/data/AmphibianCrossings.geojson",
        "style": {weight: 4, opacity: 0.8, color: '#e34a33'},
        "description": "Amphibian Road Crossings.",
        "info-params": {"Connectivity": "AmphibConnectivity", "Number of Species": "NumberSpeciesObserved", "Total Observations": "TotalObservations"},
        "info-name": "Amphibian Road Crossing",
        "filter": "1=1",
        'simplifyFactor': 0.1,
        'precision': 4
    },
    {
         "name": "Wildlife Road Crossings",
         "source": `<a href="https://www.thetfordvt.gov/government/conservation-commission">Thetford Natural Resource Inventory (NRI)</a>`,
         "url": "https://thetford-vt-conservation.github.io/maps/data/WildlifeCrossings.geojson",
         "style": {weight: 3, opacity: 0.8, color: '#ff8c00'},
        "description": "Wildlife Road Crossings.",
        "info-params": {"Target Species": "TargetSpeciesList", "Importance": "Importance", "Overall Connectivity": "OverallConnectivity"},
        "info-name": "Wildlife Road Crossing",
        "filter": "1=1",
        'simplifyFactor': 0.1,
        'precision': 4
    },
    {
         "name": "Underpass Road Crossings",
         "source": `<a href="https://www.thetfordvt.gov/government/conservation-commission">Thetford Natural Resource Inventory (NRI)</a>`,
         "url": "https://thetford-vt-conservation.github.io/maps/data/UnderpassCrossings.geojson",
        "style": {weight: 4, opacity: 0.8, color: '#e34a33', fillOpacity: 0.0, fillColor: 'white'},
        "description": "Wildlife Road Crossings.",
        "info-params": {"Size": "SizeClass", "Type":"StructureType", "Barrier Severity (Small)":"BarrierSeverity_Small", "Barrier Severity (Medium)":"BarrierSeverity_Medium"},
        "info-name": "Underpass Road Crossing",
        "filter": "1=1",
        'simplifyFactor': 0.1,
        'precision': 4
    },
    {
        "name": "Other Wildlife Crossings",
        "source": '<a href="https://vtfishandwildlife.com/conserve/vermont-conservation-design">Vermont Conservation Design</a>',
        "url": "https://anrmaps.vermont.gov/arcgis/rest/services/EGC_Services/MAP_ANR_BIOFINDER4_WM_NOCACHE/MapServer/2",
        "info-name":"Wildlife Crossings",
        "description": `Areas on smaller roads that have been identified identified by the Vermont Conservation Design as locations where wildlife are likely to cross.  More information can be found in the <a href="https://anr.vermont.gov/sites/anr/files/documents/Wildlife%20Road%20Crossings%20Summary.pdf?_gl=1*1rebr*_ga*MTM3OTc4OTc2OC4xNzI1NDkzMTMy*_ga_V9WQH77KLW*MTczMjQ3ODc4My41LjAuMTczMjQ3OTE1MS4wLjAuMA">VCD documentation</a>.`,
        "info-params": {},
        "style": {color: '#e34a33', weight: 1, opacity: 1.0},
        "filter": ` WildlifeRoadCrossings='HIGHEST PRIORITY'`,
        'simplifyFactor': 0.1,
        'precision': 4
    }], "Political Boundaries":[
    {
        "name": "Use Value Appraisal",
        "source": `<a href="https://anr.vermont.gov/">VT Agency of Natural Resources<a>`,
        "url": "https://anrmaps.vermont.gov/arcgis/rest/services/Open_Data/OPENDATA_ANR_CADASTRAL_SP_NOCACHE_v2/MapServer/41",
        "style": {weight:1, color:'#a10303',opacity:0.7, fillOpacity:0.2, fillColor:'#a10303'},
        "description": `Parcels enrolled in Vermont's <a href="https://fpr.vermont.gov/forest/UseValueAppraisal">use value appraisal program</a> (i.e., parcels "in current use").`,
        "info-params": {'SPAN':'SPAN', 'Entry Year':'ENTRYYEAR'},
        "info-name": "Parcel in Current Use",
        "filter": "1=1",
        'simplifyFactor': 0.1,
        'precision': 6
    },
    {
        "name": "Thetford Zoning Districts",
        "source": `<a href="https://www.trorc.org/">Two Rivers Ottauquechee Regional Commission (TRORC)`,
        "url": "https://services1.arcgis.com/u6q3LNruiYmDjGX5/arcgis/rest/services/VTZONING_THETFORD_20110926_poly_zones/FeatureServer/0",
        "style": {weight:1, color:'#756bb1', opacity:0.9, fillOpacity:0.4, fillColor:'#756bb1'},
        "description": `Thetford zoning districts.  Any areas not covered by these zones is considered "Rural Residential".  More information is available from the <a href="https://www.thetfordvt.gov/departments/zoning">Thetford Zoning website</a>.`,
        "info-params": {"Type": "DISTRICT"},
        "info-name": "Development Zone",
        "filter": "NOT (DISTRICT ='RURAL RESIDENTIAL')",
        'simplifyFactor': 0.1,
        'precision': 6
    },
    {
        "name": "Parcels",
        "source": `<a href="https://vcgi.vermont.gov/">VT Center for Geographic Information</a>`,
        "url": "https://services1.arcgis.com/BkFxaEFNwHqX3tAw/arcgis/rest/services/FS_VCGI_VTPARCELS_WM_NOCACHE_v2/FeatureServer/1",
        "style": {weight: 1, opacity: 0.8, color: '#979797', fillOpacity: 0.0, fillColor: 'white'},
        "description": "Boundaries of parcels in Thetford.",
        "filter": "TOWN='THETFORD'",
        "info-params": {"SPAN": "GLIST_SPAN", "Address": "E911ADDR"},
        "info-name": "Parcel",
        'simplifyFactor': 0.1,
        'precision': 6
    },
    {
        "name": "Conserved Lands",
        "source": `<a href="https://anr.vermont.gov/">VT Agency of Natural Resources</a>`,
        "url": "https://services5.arcgis.com/Uzks6LSde6r23wwG/arcgis/rest/services/Conserved_Land_Inventory_Public_View/FeatureServer/0",
        "description": `Highlights land that is protected through conservation easements or public ownership.  
        More information, including the definitions of public access type numbers, can be found in the <a href="https://geodata.vermont.gov/datasets/VTANR::conserved-land-inventory/about">
        Vermont Conserved Lands Inventory</a>.`,
        "style": {weight: 1, opacity: 0.8, color: '#F1C40F', fillOpacity: 0.4, fillColor: '#F1C40F'},
        "info-params": {"Name":"AREA_NAME"},
        "info-name": "Conserved Land",
        "filter": "1=1",
        'simplifyFactor': 0.2,
        'precision': 5
    },
    {
        "name": "Thetford Town Lands",
        "source": `<a href="https://vcgi.vermont.gov/">VT Center for Geographic Information</a>`,
        "url": "https://thetford-vt-conservation.github.io/maps/data/TownLands.geojson",
        "style": {weight: 2, opacity: 0.5, color: '#979797', fillOpacity: 0.5, fillColor: 'white'},
        "description": "Parcels owned by or leased from the Town of Thetford.",
        "filter": "TOWN='THETFORD'",
        "info-params": {"SPAN": "GLIST_SPAN", "Address": "E911ADDR"},
        "info-name": "Town Land",
        'simplifyFactor': 0.1,
        'precision': 6
    },
    {   
        "name": "Town Boundaries",
        "source": `<a href="https://vcgi.vermont.gov/">VT Center for Geographic Information</a>`,
        "url": "https://services1.arcgis.com/BkFxaEFNwHqX3tAw/arcgis/rest/services/FS_VCGI_OPENDATA_Boundary_BNDHASH_line_SP_v1/FeatureServer/0",
        "style": {weight: 2, opacity: 0.6, color: '#979797'},
        "description": "Political boundaries between towns.",
        "info-params": {},
        "info-name": "Town Boundary",
        "active": true,
        "filter": "1=1",
        'simplifyFactor': 0.1,
        'precision': 4
    }]};



    var overlays = [];
    console.log(layerData);
    for (var gkey in layerData) {
        const group = layerData[gkey];
        console.log(group);
        overlays.push({group: gkey, collapsed: true, layers: []});
    
        for (var i =0; i<group.length; i++) {
            const d = group[i];
            console.log("here 1");

            // Define a function that maps the feature to a style
            let styleFunc = (feature) => d['style'];
            if ("categorical-style" in d){
                styleFunc = function(feature) {
                    return d['categorical-style'][feature.properties[d['categorical-style']['key']]];
                };
            }
            
            // Define a function that generates the info box HTML
            let infoFunc = function(feature, layer) {

                // Hover event information box
                layer.on('mouseover', function(e) {
                    var infoBox = document.getElementById('info-box');
                    //console.log(feature.properties); // TODO: Remove this once we have all layers in place
                    infoBox.innerHTML = "<strong>" + d["info-name"] + "</strong></br>";
                    for (var key in d["info-params"]){
                        infoBox.innerHTML += key + ": "

                        var value = feature.properties[d["info-params"][key]];
                        if(typeof(value)=='number'){
                            if (value % 1 === 0){
                                infoBox.innerHTML += value;
                            }else{
                                infoBox.innerHTML += value.toFixed(2);
                            }
                        }else{
                            infoBox.innerHTML += value;
                        }
                        
                        infoBox.innerHTML += "</br>"
                    }
                    infoBox.style.display = 'block';
                });

                // Mouse out event to remove info box
                layer.on('mouseout', function(e) {
                    document.getElementById('info-box').style.display = 'none';
                });
            }
            
            modal_name = d['name'].replace(/\s+/g, '-').toLowerCase();
            
            // Create the layer with static settings
            let layer;
            if (d['url'] && d['url'].endsWith('.geojson')) {
                // Use GeoJSON layer for GeoJSON URLs
                layer = L.geoJSON(null, {
                    style: styleFunc,
                    onEachFeature: infoFunc
                });
                
                // Load the GeoJSON file
                fetch(d['url'])
                    .then(response => response.json())
                    .then(data => {
                        layer.addData(data);
                        
                        // If this layer should be active by default, add it to the map
                        if (d.active) {
                            layer.addTo(map);
                        }
                    })
                    .catch(error => {
                        console.error('Error loading GeoJSON file:', error);
                    });
            } else if (d['url'] && d['url'].trim() !== '') {
                // Use Esri feature layer for remote services
                layer = L.esri.featureLayer({
                    url: d['url'],
                    style: styleFunc,
                    onEachFeature: infoFunc, 
                    simplifyFactor: d.simplifyFactor,
                    where: d.filter,
                    precision: d.precision,
                });
            } else {
                console.error('Layer "' + d['name'] + '" has neither URL nor file specified');
            }

            // Add layer to overlays array
            overlays[overlays.length - 1]['layers'].push({
                'name': d['name'],
                'icon': `<a href="#" data-bs-toggle="modal" data-bs-target="#${modal_name}"><i style="font-size:14px" class="fa">&#xf05a;</i></a>`,
                'layer': layer,
                'active': d.active || false,
                'layerData': d
            });
            
            // add modal with detailed information about the layer
            const modal = document.createElement("div");
            modal.classList.add("modal");
            modal.classList.add("fade");
            modal.id = `${modal_name}`;
            modal.role = "dialog";
            const modalContent = `
            <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h4 class="modal-title" id="modalTitle">${d['name']}</h4>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <table class="table">
                                <tbody>
                                    <tr>
                                    <th scope="row">Description</th>
                                    <td>${d['description']}</td>
                                    </tr>
                                    <tr>
                                    <th scope="row">Source Organization</th>
                                    <td>${d['source']}</td>
                                    </tr>
                                    <tr>
                                    <th scope="row">Link</th>
                                    <td ><a href="${d['url']}">layer source</a></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            `;
            modal.innerHTML = modalContent;

            document.body.appendChild(modal);
        };
    };
    
    var baseLayers = [
        {
            'active': true,
            'name': "World Streets",
            'layer': worldStreetMap
        },
        {
            'name': "Aerial Imagery",
            'layer': imagery
        },
        {
            'name': "Terrain",
            'layer': hillshade
        }
    ];
    
    var panelLayers = new L.Control.PanelLayers(baseLayers, overlays, 
    {
        collapsibleGroups: true,
        collapsed: false,
        collapsible: true,
        className: 'custom-collapsible-panel'
    });

    map.addControl(panelLayers);

    // Add toggle button functionality
    setTimeout(() => {
        const panel = document.querySelector('.custom-collapsible-panel');
        if (panel) {
            // Create toggle button
            const toggleButton = document.createElement('div');
            toggleButton.className = 'hamburger-toggle minimize';
            toggleButton.innerHTML = '−'; // Minimize symbol
            
            // Add click handler
            toggleButton.addEventListener('click', function(e) {
                e.stopPropagation();
                panel.classList.toggle('collapsed');
                
                // Update button content and class
                if (panel.classList.contains('collapsed')) {
                    toggleButton.className = 'hamburger-toggle hamburger';
                    toggleButton.innerHTML = '<span></span><span></span><span></span>';
                } else {
                    toggleButton.className = 'hamburger-toggle minimize';
                    toggleButton.innerHTML = '−';
                }
            });
            
            // Insert toggle button
            panel.appendChild(toggleButton);
        }
    }, 100);

  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>
</html>