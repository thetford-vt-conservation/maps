<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Conservation Map -- Preliminary</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <!-- Load Esri Leaflet from CDN -->
    <script src="https://unpkg.com/esri-leaflet@3.0.12/dist/esri-leaflet.js"></script>

    <!-- Load Esri Leaflet Vector from CDN -->
    <script src="https://unpkg.com/esri-leaflet-vector@4.2.5/dist/esri-leaflet-vector.js" crossorigin=""></script>

    <!-- Add leaflet panel layers for layer control panel-->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-panel-layers@1.3.1/dist/leaflet-panel-layers.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/leaflet-panel-layers@1.3.1/dist/leaflet-panel-layers.min.css" rel="stylesheet">

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <style>
    html,
    body,
    #map {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 14px;
      color: #323232;
    }
    #info-box {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 10px;
        border: 1px solid #ccc;
        z-index: 1000;
        opacity: 0.8;
        display: none;
    }
  </style>

</head>
<body>

  <div id="map"></div>
  <div id="info-box"></div>
  <script>

  // initialize the map
  
  var map = L.map('map').setView([43.835189, -72.252179], 12);

    var worldStreetMap = L.esri.basemapLayer('Streets').addTo(map);

    var imagery = L.esri.imageMapLayer({'url':"http://maps.vcgi.vermont.gov/arcgis/rest/services/EGC_services/IMG_VCGI_CLR2022_WM_CACHE/ImageServer"});
    var hillshade = L.esri.imageMapLayer({'url':"http://maps.vcgi.vermont.gov/arcgis/rest/services/EGC_services/IMG_VCGI_LIDARHILLSHD_WM_CACHE_v1/ImageServer"});
    
    worldStreetMap.addTo(map);
    
    const layerData = [
    {
        "name": "Interior Forest Blocks",
        "source": '<a href="https://vtfishandwildlife.com/conserve/vermont-conservation-design">Vermont Conservation Design</a>',
        "description": `According to BioFinder, "Interior Forest Blocks are a selection of habitat blocks that best provide interior forest conditions in
each biophysical region of Vermont. Habitat blocks themselves are areas of contiguous forest and
other natural habitats that are unbroken by roads, development, or agriculture".  
See <a href="https://anr.vermont.gov/sites/anr/files/documents/Interior%20Forest%20Summary.pdf">the biofinder documentation</a> for more details.`,
        "info-name": "Interior Forest Block",
        "url": "https://anrmaps.vermont.gov/arcgis/rest/services/EGC_Services/MAP_ANR_BIOFINDER4_WM_NOCACHE/MapServer/1",
        "categorical-style": {"key": "Interior_Forest_Priority", 
                              "Highest Priority":{weight:1, color:'#28B463', opacity:0.8, fillOpacity:0.3, fillColor:'#28B463'},
                              "Priority": {weight:1, color:'#28B463', opacity:0.5, fillOpacity:0.1, fillColor:'#28B463'}
                            },
        "info-params": {'Acreage': 'habitat_block_area_acres', 'Priority':'Interior_Forest_Priority', 'Biophysical Region': 'biophysical_region_name', 'Percent Conserved': 'conserved_land_pct', 'Vernal Pool Count':'vernal_pool_count'},
        "filter": `Interior_Forest='Interior Forest'`,
        'simplifyFactor': 0.3,
        'precision': 4,
        // Zoom-specific configurations
        'zoomConfigs': {
            'low': { // zoom levels 0-8
                'simplifyFactor': 0.8,
                'precision': 2,
                'filter': `Interior_Forest='Interior Forest' AND habitat_block_area_acres > 100`
            },
            'medium': { // zoom levels 9-12
                'simplifyFactor': 0.8,
                'precision': 2,
                'filter': `Interior_Forest='Interior Forest'`
            },
            'high': { // zoom levels 13+
                'simplifyFactor': 0.1,
                'precision': 8,
                'filter': `Interior_Forest='Interior Forest'`
            }
        },
        'minZoom': 6, // Don't show this layer below zoom level 6
    },
    {
        "name": "Forest Connectivity Blocks",
        "source": '<a href="https://anr.vermont.gov/">Vermont Agency of Natural Resource (ANR)</a>',
        "description": `According to BioFinder, "Connectivity Blocks are a selection of habitat blocks that create a connected network of forest across
Vermont and into adjacent states and provinces. These are mostly forested areas but also include
shrubland and wetland. They include the largest forests that are serving as core habitat, as well as
sometimes smaller, connecting blocks. Connectivity Blocks are the network of forest blocks that together
provide terrestrial connectivity at the regional scale, across Vermont and to adjacent states and Québec,
and connectivity between all Vermont biophysical regions."
See <a href="https://anr.vermont.gov/sites/anr/files/documents/Connectivity%20Blocks%20Summary.pdf">the biofinder documentation</a> for more details.`,
        "info-name": "Forest Connectivity Block",
        "url": "https://anrmaps.vermont.gov/arcgis/rest/services/EGC_Services/MAP_ANR_BIOFINDER4_WM_NOCACHE/MapServer/1",
        "categorical-style": {"key": "Connectivity_Blocks_Priority", 
                              "Highest Priority":{weight:1, color:'#73C6B6', opacity:0.8, fillOpacity:0.3, fillColor:'#73C6B6'},
                              "Priority": {weight:1, color:'#73C6B6', opacity:0.8, fillOpacity:0.1, fillColor:'#73C6B6'}
                            },
        "info-params": {'Acreage': 'habitat_block_area_acres', 'Priority':'Connectivity_Blocks_Priority', 'Biophysical Region': 'biophysical_region_name', 'Percent Conserved': 'conserved_land_pct', 'Vernal Pool Count':'vernal_pool_count'},
        "filter": `Connectivity_Blocks='Connectivity Block'`,
        'simplifyFactor': 0.3,
        'precision': 4,
    },
    {
        "name": "Surface Water",
        "source": '<a href="https://vtfishandwildlife.com/conserve/vermont-conservation-design">Vermont Conservation Design</a>',
        "url": "https://anrmaps.vermont.gov/arcgis/rest/services/EGC_Services/MAP_ANR_BIOFINDER4_WM_NOCACHE/MapServer/0",
        "info-name":"Highest Priority Surface Water",
        "description": `This layer contains the highest priority areas with "Vermont’s network of lakes, ponds, rivers and streams, and their associated
riparian zones, valley bottoms, and river corridors".  For more information on this data and its ecological importance, consult the Vermont Conservation 
 Design's <a href="https://vtfishandwildlife.com/sites/fishandwildlife/files/documents/Conserve/VT%20Conservation%20Landscape-level%20Design/Surface-Waters-and-Riparian-Areas.pdf">Surface Waters and Riparian Areas</a> documentation. `,
        "info-params": {},
        "style": {weight:1, color:'#344ceb', opacity:0.8, fillOpacity:0.4, fillColor:'#344ceb'},
        "filter": `SurfaceWaterPriority='HIGHEST PRIORITY'`
    },
    {
        "name": "Vernal Pools",
        "source": '<a href="https://vtfishandwildlife.com/conserve/vermont-conservation-design">Vermont Conservation Design</a>',
        "url": "https://anrmaps.vermont.gov/arcgis/rest/services/EGC_Services/MAP_ANR_BIOFINDER4_WM_NOCACHE/MapServer/2",
        "info-name":"Vernal Pools",
        "description": `Possible vernal pools with a 650ft buffer.  From the 
        <a href="https://anr.vermont.gov/sites/anr/files/documents/Vernal%20Pools%20Summary.pdf?_gl=1*f5q9ds*_ga*MTM3OTc4OTc2OC4xNzI1NDkzMTMy*_ga_V9WQH77KLW*MTczMjQ3ODc4My41LjAuMTczMjQ3ODc4NS4wLjAuMA">Vermont Conservation Design documentation</a>, 
" Vernal Pools are small (generally less than oneacre), ephemeral pools that occur in natural basins within upland forests. 
They typically have no permanent inlet or outlet streams and have very small watersheds."  This layer shows only the "highest priority" 
vernal pools, which have been field verified.`,
        "info-params": {},
        "style": {weight:1, color:'#2a7862', opacity:0.8, fillOpacity:0.8, fillColor:'#2a7862'},
        "filter": `VernalPools='HIGHEST PRIORITY'`,
        // Only show vernal pools at higher zoom levels since they're small features
        'minZoom': 10,
        'zoomConfigs': {
            'medium': { // zoom levels 10-12
                'simplifyFactor': 0.2,
                'precision': 4,
                'filter': `VernalPools='HIGHEST PRIORITY'`
            },
            'high': { // zoom levels 13+
                'simplifyFactor': 0.05,
                'precision': 6,
                'filter': `VernalPools='HIGHEST PRIORITY'`
            }
        }
    },
    {
        "name": "Agricultural Soils",
        "source": `<a href="https://vcgi.vermont.gov/">VT Center for Geographic Information</a>`,
        "url": "https://maps.vcgi.vermont.gov/arcgis/rest/services/EGC_services/OPENDATA_VCGI_GEOLOGIC_SP_NOCACHE_v1/MapServer/2",
        "info-name":"Agricultural Soil",
        "description": `A subset of the USGS <a href="https://www.nrcs.usda.gov/resources/data-and-reports/soil-survey-geographic-database-ssurgo">"Soil Survey Geographic Database"</a>
        created by the state of Vermont to identify prime agricultural soils in the state.`,
        "info-params": {'Prime Type': 'PRIME'},
        "style": {weight:1, color:'#d6b024', opacity:0.8, fillOpacity:0.3, fillColor:'#d6b024'},
        'simplifyFactor': 0.2,
    },
    {
        "name": "Use Value Appraisal",
        "source": `<a href="https://anr.vermont.gov/">VT Agency of Natural Resources<a>`,
        "url": "https://anrmaps.vermont.gov/arcgis/rest/services/Open_Data/OPENDATA_ANR_CADASTRAL_SP_NOCACHE_v2/MapServer/41",
        "style": {weight:1, color:'#a10303',opacity:0.7, fillOpacity:0.2, fillColor:'#a10303'},
        "description": `Parcels enrolled in Vermont's <a href="https://fpr.vermont.gov/forest/UseValueAppraisal">use value appraisal program</a> (i.e., parcels "in current use").`,
        "info-params": {'SPAN':'SPAN', 'Entry Year':'ENTRYYEAR'},
        "info-name": "Parcel in Current Use"
    },
    {
        "name": "Wetlands",
        "source": `<a href="https://anr.vermont.gov/">VT Agency of Natural Resources<a>`,
        "url": "https://services5.arcgis.com/Uzks6LSde6r23wwG/ArcGIS/rest/services/Vermont_Significant_Wetland_Inventory/FeatureServer/0",
        "style": {weight:1, color:'#06cf82', opacity:0.8, fillOpacity:0.4, fillColor:'#06cf82'},
        "description": `Data from the <a href="https://dec.vermont.gov/watershed/wetlands/maps">Vermont Significant Wetlands Inventory (VSWI)</a>. 
        From the <a href="https://anrgeodata.vermont.gov/datasets/VTANR::vswi-wetlands-class-layer/about">ANR documentation</a>, 
        "The State of Vermont protects wetlands which provide significant functions and values and also protects a buffer zone directly
        adjacent to significant wetlands. Wetlands in Vermont are classified as Class I, II, or III based on the significance of the 
        functions and values they provide. Class I and Class II wetlands provide significant functions and values and are protected 
        by the Vermont Wetland Rules."  Additional information can be found in the 
        <a href="https://anrmaps.vermont.gov/websites/WetlandScreening/Docs/2021%20Mapping%20Guidance%20VSWI.pdf">data description</a> provided by the Vermont Wetlands Program. `,
        "info-params": {'Class':'CLASS'},
        "info-name": "Wetland"
    },
    {
        "name": "Highway Crossings",
        "source": `<a href="https://vcgi.vermont.gov/">VT Center for Geographic Information</a>`,
        "url": "https://maps.vcgi.vermont.gov/arcgis/rest/services/EGC_services/OPENDATA_VCGI_ECOLOGIC_SP_NOCACHE_v1/MapServer/8",
        "description": `Wildlife crossing ares across state highways. From the <a href="https://geodata.vermont.gov/datasets/VCGI::vt-wildlife-crossing-value/about">VCGI documentation</a>, "The values of the [wildlife crossing value] WCV range from 1-10, ten being the
         most signifigant and 1 being the least signifigant. The relative ranking systems allows for relative priority areas within 
         different regions. This provides a roadway specific description of potential WLH and may be useful for purposes of 
         transportation planning and identification of sites that may be priority areas for wildlife crossing structures. 
         The Wildlife Linkage Habitat Analysis uses landscape scale data to identify or predict the location of potentially significant
          wildlife linkage habitats (WLH) associated with state roads throughout Vermont. For purposes of this project, 
          WLH is a term used to describe those habitats associated with Vermont roads where wildlife move, migrate, and access 
          various other habitats and parts of their range (similar to, but broader than, wildlife corridors)."`,
        "style": {color: '#e34a33', weight: 3, opacity: 1.0},
        "info-params": {"Crossing Value": "WCV_MASTER"},
        "info-name": "Wildlife Crossing"
    },
    {
        "name": "Other Wildlife Crossings",
        "source": '<a href="https://vtfishandwildlife.com/conserve/vermont-conservation-design">Vermont Conservation Design</a>',
        "url": "https://anrmaps.vermont.gov/arcgis/rest/services/EGC_Services/MAP_ANR_BIOFINDER4_WM_NOCACHE/MapServer/2",
        "info-name":"Wildlife Crossings",
        "description": `Areas on smaller roads that have been identified identified by the Vermont Conservation Design as locations where wildlife are likely to cross.  More information can be found in the <a href="https://anr.vermont.gov/sites/anr/files/documents/Wildlife%20Road%20Crossings%20Summary.pdf?_gl=1*1rebr*_ga*MTM3OTc4OTc2OC4xNzI1NDkzMTMy*_ga_V9WQH77KLW*MTczMjQ3ODc4My41LjAuMTczMjQ3OTE1MS4wLjAuMA">VCD documentation</a>.`,
        "info-params": {},
        "style": {color: '#e34a33', weight: 1, opacity: 1.0},
        "filter": ` WildlifeRoadCrossings='HIGHEST PRIORITY'`
    },
    {
        "name": "Deer Wintering Areas",
        "source": `<a href="https://anr.vermont.gov/">VT Agency of Natural Resources<a>`, 
        "url": "https://anrmaps.vermont.gov/arcgis/rest/services/Open_Data/OPENDATA_ANR_ECOLOGIC_SP_NOCACHE_v1/MapServer/171",
        "style": {weight:1, color:'#A04000', opacity:0.8, fillOpacity:0.2, fillColor:'#A04000'},
        "description": `From the ANR description: "Deer winter habitat is critical to the long term survival of white-tailed 
        deer (Odocoileus virginianus) in Vermont. Being near the northern extreme of the white-tailed deer's range, 
        functional winter habitats are essential to maintain stable populations of deer in many years when and where 
        yarding conditions occur. Consequently, deer wintering areas are considered under Act 250 and other local, state,
         and federal regulations that require the protection of important wildlife habitats. DWAs are generally characterized 
         by rather dense softwood (conifer) cover, such as hemlock, balsam fir, red spruce, or white pine. Occasionally DWAs 
         are found in mixed forest with a strong softwood component or even on found west facing hardwood slopes in conjunction 
         with softwood cover." More information in VT ANR's <a href="https://vtfishandwildlife.com/sites/fishandwildlife/files/documents/Learn%20More/LandownersGuide/8.Deer_.pdf">Deer Wintering Management</a> document.`,
        "info-params": {"Acreage": "Acres", "Rating":"Rating"},
        "info-name": "Deer Wintering Area"
    },
    {
        "name": "Thetford Zoning Districts",
        "source": `<a href="https://www.trorc.org/">Two Rivers Ottaquechee Region Commission (TRORC)`,
        "url": "https://services1.arcgis.com/u6q3LNruiYmDjGX5/arcgis/rest/services/VTZONING_THETFORD_20110926_poly_zones/FeatureServer/0",
        "style": {weight:1, color:'#756bb1', opacity:0.9, fillOpacity:0.4, fillColor:'#756bb1'},
        "description": `Thetford zoning districts.  Any areas not covered by these zones is considered "Rural Residential".  More information is available from the <a href="https://www.thetfordvt.gov/departments/zoning">Thetford Zoning website</a>.`,
        "info-params": {"Type": "DISTRICT"},
        "info-name": "Development Zone",
        "filter": "NOT (DISTRICT ='RURAL RESIDENTIAL')"
    },
    {
        "name": "Parcels",
        "source": `<a href="https://vcgi.vermont.gov/">VT Center for Geographic Information</a>`,
        "url": "https://services1.arcgis.com/BkFxaEFNwHqX3tAw/arcgis/rest/services/FS_VCGI_VTPARCELS_WM_NOCACHE_v2/FeatureServer/1",
        "style": {weight: 1, opacity: 0.8, color: '#979797', fillOpacity: 0.0, fillColor: 'white'},
        "description": "Boundaries of parcels in Thetford.",
        "filter": "TOWN='THETFORD'",
        "info-params": {"SPAN": "GLIST_SPAN", "Address": "E911ADDR"},
        "info-name": "Parcel"
    },
    {
        "name": "Protected Lands",
        "source": ``,
        "url": "https://maps.vcgi.vermont.gov/arcgis/rest/services/EGC_services/OPENDATA_VCGI_CADASTRAL_SP_NOCACHE_v1/MapServer/10",
        "description": `Highlights land that is protected through conservation easements or public ownership.  
        More information, includign the definitions of public access type numbers, can be found in the <a href="https://vcgi.vermont.gov/sites/vcgiupdate/files/doc_library/Protectedlands_Standard_v1.4.Final_.pdf">
        Vermont Protected Lands Database</a>.`,
        "style": {weight: 1, opacity: 0.8, color: '#F1C40F', fillOpacity: 0.4, fillColor: '#F1C40F'},
        "info-params": {"Name": "NAME", "Public Access Type": "PUBACCESS", "Protection Type": "PTYPE1"},
        "info-name": "Protected Land"
    },
    {   
        "name": "Town Boundaries",
        "source": `<a href="https://vcgi.vermont.gov/">VT Center for Geographic Information</a>`,
        "url": "https://services1.arcgis.com/BkFxaEFNwHqX3tAw/arcgis/rest/services/FS_VCGI_OPENDATA_Boundary_BNDHASH_line_SP_v1/FeatureServer/0",
        "style": {weight: 3, opacity: 0.8, color: '#979797'},
        "description": "Political boundaries between towns.",
        "active": true,
    },
    ];


    // Function to get zoom-appropriate configuration
    function getZoomConfig(layerData, zoomLevel) {
        if (!layerData.zoomConfigs) {
            // Fallback to simple zoom-based calculation
            return {
                simplifyFactor: getSimplificationFactor(layerData.simplifyFactor, zoomLevel),
                precision: getPrecision(zoomLevel),
                filter: layerData.filter
            };
        }

        // Determine zoom category
        let zoomCategory;
        if (zoomLevel <= 8) {
            zoomCategory = 'low';
        } else if (zoomLevel <= 12) {
            zoomCategory = 'medium';
        } else {
            zoomCategory = 'high';
        }

        const config = layerData.zoomConfigs[zoomCategory] || layerData.zoomConfigs['medium'];
        return {
            simplifyFactor: config.simplifyFactor || layerData.simplifyFactor,
            precision: config.precision || 4,
            filter: config.filter || layerData.filter
        };
    }

    // Function to get zoom-appropriate simplification factor (fallback)
    function getSimplificationFactor(baseFactor, zoomLevel) {
        if (!baseFactor) return null;
        // More detail at higher zoom levels (lower simplification)
        const zoomFactor = Math.max(0.1, baseFactor * (1 - (zoomLevel - 8) * 0.1));
        return Math.max(0.1, Math.min(1.0, zoomFactor));
    }

    // Function to get zoom-appropriate precision (fallback)
    function getPrecision(zoomLevel) {
        // Higher precision (more decimal places) at higher zoom levels
        return Math.min(6, Math.max(2, Math.floor(zoomLevel / 2)));
    }

    var overlays = [{group: "Overlays", collapsed: true, layers: []}];
    for (var i =0; i<layerData.length; i++) {
        const d = layerData[i];

        // Define a function that maps the feature to a style
        let styleFunc = (feature) => d['style'];
        if ("categorical-style" in d){
            styleFunc = function(feature) {
                return d['categorical-style'][feature.properties[d['categorical-style']['key']]];
            };
        }
        
        // Define a function that generates the info box HTML
        let infoFunc = function(feature, layer) {

            // Hover event information box
            layer.on('mouseover', function(e) {
                var infoBox = document.getElementById('info-box');
                //console.log(feature.properties); // TODO: Remove this once we have all layers in place
                infoBox.innerHTML = "<strong>" + d["info-name"] + "</strong></br>";
                for (var key in d["info-params"]){
                    infoBox.innerHTML += key + ": "

                    var value = feature.properties[d["info-params"][key]];
                    if(typeof(value)=='number'){
                        if (value % 1 === 0){
                            infoBox.innerHTML += value;
                        }else{
                            infoBox.innerHTML += value.toFixed(2);
                        }
                    }else{
                        infoBox.innerHTML += value;
                    }
                    
                    infoBox.innerHTML += "</br>"
                }
                infoBox.style.display = 'block';
            });

            // Mouse out event to remove info box
            layer.on('mouseout', function(e) {
                document.getElementById('info-box').style.display = 'none';
            });
        }
        
        modal_name = d['name'].replace(/\s+/g, '-').toLowerCase();
        // Create the layer with initial zoom-appropriate settings
        const currentZoom = map.getZoom();
        const zoomConfig = getZoomConfig(d, currentZoom);
        
        const layer = L.esri.featureLayer({
            url: d['url'],
            style: styleFunc,
            onEachFeature: infoFunc, 
            simplifyFactor: zoomConfig.simplifyFactor,
            where: zoomConfig.filter,
            precision: zoomConfig.precision
        });

        overlays[0]['layers'].push({
            'name': d['name'],
            'icon': `<a href="#" data-bs-toggle="modal" data-bs-target="#${modal_name}"><i style="font-size:14px" class="fa">&#xf05a;</i></a>`,
            'layer': layer,
            'active': d.active || false,
            'layerData': d // Store original layer data for zoom updates
        });
        
        // add modal with detailed information about the layer
        const modal = document.createElement("div");
        modal.classList.add("modal");
        modal.classList.add("fade");
        modal.id = `${modal_name}`;
        modal.role = "dialog";
        const modalContent = `
        <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="modalTitle">${d['name']}</h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <table class="table">
                            <tbody>
                                <tr>
                                <th scope="row">Description</th>
                                <td>${d['description']}</td>
                                </tr>
                                <tr>
                                <th scope="row">Source Organization</th>
                                <td>${d['source']}</td>
                                </tr>
                                <tr>
                                <th scope="row">Link</th>
                                <td ><a href="${d['url']}">layer source</a></td>
                                </tr>
                            </tbody>
                         </table>
                    </div>
                </div>
            </div>
        </div>
        `;
        modal.innerHTML = modalContent;

        document.body.appendChild(modal);
    };
    
    var baseLayers = [
        {
            'active': true,
            'name': "World Streets",
            'layer': worldStreetMap
        },
        {
            'name': "Aerial Imagery",
            'layer': imagery
        },
        {
            'name': "Terrain",
            'layer': hillshade
        }
    ];
    
    var panelLayers = new L.Control.PanelLayers(baseLayers, overlays, 
    {
        collapsibleGroups: true,
        collapsed: true,
        collapsible: true
    });

    map.addControl(panelLayers);

    // Add zoom event listener to update layer parameters
    let zoomTimeout;
    map.on('zoomend', function() {
        // Debounce zoom events to avoid too many updates
        clearTimeout(zoomTimeout);
        zoomTimeout = setTimeout(function() {
            updateLayersForZoom();
        }, 500);
    });

    // Function to update all active layers for current zoom level
    function updateLayersForZoom() {
        const currentZoom = map.getZoom();
        
        // Update each layer in the overlays
        overlays[0]['layers'].forEach(function(layerInfo) {
            if (layerInfo.layer && layerInfo.layer._map) {
                const layerData = layerInfo.layerData;
                
                // Check if layer should be visible at this zoom level
                if (layerData.minZoom && currentZoom < layerData.minZoom) {
                    if (map.hasLayer(layerInfo.layer)) {
                        map.removeLayer(layerInfo.layer);
                    }
                    return;
                }
                
                if (layerData.maxZoom && currentZoom > layerData.maxZoom) {
                    if (map.hasLayer(layerInfo.layer)) {
                        map.removeLayer(layerInfo.layer);
                    }
                    return;
                }
                
                // Get zoom-appropriate configuration
                const zoomConfig = getZoomConfig(layerData, currentZoom);
                
                // Update the layer's options
                if (layerInfo.layer.options) {
                    layerInfo.layer.options.simplifyFactor = zoomConfig.simplifyFactor;
                    layerInfo.layer.options.precision = zoomConfig.precision;
                    layerInfo.layer.options.where = zoomConfig.filter;
                }
                
                // Refresh the layer to apply new parameters
                layerInfo.layer.refresh();
            }
        });
    }

    // Optional: Add zoom-based layer visibility control
    function updateLayerVisibility() {
        const currentZoom = map.getZoom();
        
        overlays[0]['layers'].forEach(function(layerInfo) {
            if (layerInfo.layer && layerInfo.layer._map) {
                const layerData = layerInfo.layerData;
                
                // Example: Hide detailed layers at low zoom levels
                if (layerData.minZoom && currentZoom < layerData.minZoom) {
                    if (map.hasLayer(layerInfo.layer)) {
                        map.removeLayer(layerInfo.layer);
                    }
                } else if (layerData.maxZoom && currentZoom > layerData.maxZoom) {
                    if (map.hasLayer(layerInfo.layer)) {
                        map.removeLayer(layerInfo.layer);
                    }
                }
            }
        });
    }

  </script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</body>
</html>